# KES-SMART PWA Offline Architecture Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           USER DEVICE                                     │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                        WEB BROWSER                                  │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                    USER INTERFACE                             │ │  │
│  │  │                                                               │ │  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │ │  │
│  │  │  │ Index.php│  │Dashboard │  │QR-Scanner│  │Attendance│   │ │  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │ │  │
│  │  │       │              │              │              │         │ │  │
│  │  └───────┼──────────────┼──────────────┼──────────────┼─────────┘ │  │
│  │          │              │              │              │           │  │
│  │          ▼              ▼              ▼              ▼           │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │               SERVICE WORKER (sw.js)                         │ │  │
│  │  │                                                               │ │  │
│  │  │  ┌─────────────────────────────────────────────────────┐    │ │  │
│  │  │  │          REQUEST INTERCEPTION                        │    │ │  │
│  │  │  │                                                       │    │ │  │
│  │  │  │   Network     Cache      IndexedDB    localStorage   │    │ │  │
│  │  │  │   Request  ←→ Match   ←→  Lookup   ←→  Retrieve    │    │ │  │
│  │  │  │      ↓          ↓           ↓            ↓          │    │ │  │
│  │  │  │   [Online?] → [Cached?] → [Stored?] → [Session?]   │    │ │  │
│  │  │  └─────────────────────────────────────────────────────┘    │ │  │
│  │  │                                                               │ │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐            │ │  │
│  │  │  │   Static   │  │  Dynamic   │  │    API     │            │ │  │
│  │  │  │   Cache    │  │   Cache    │  │   Cache    │            │ │  │
│  │  │  │   (50MB)   │  │   (50MB)   │  │   (25MB)   │            │ │  │
│  │  │  └────────────┘  └────────────┘  └────────────┘            │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                OFFLINE DATA LAYER                             │ │  │
│  │  │                                                               │ │  │
│  │  │  ┌──────────────────────────────────────────────────────┐   │ │  │
│  │  │  │              IndexedDB                                │   │ │  │
│  │  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ │   │ │  │
│  │  │  │  │    Login     │ │  Attendance  │ │    Forms     │ │   │ │  │
│  │  │  │  │  Attempts    │ │   Records    │ │ Submissions  │ │   │ │  │
│  │  │  │  │  (synced:f)  │ │  (synced:f)  │ │  (synced:f)  │ │   │ │  │
│  │  │  │  └──────────────┘ └──────────────┘ └──────────────┘ │   │ │  │
│  │  │  └──────────────────────────────────────────────────────┘   │ │  │
│  │  │                                                               │ │  │
│  │  │  ┌──────────────────────────────────────────────────────┐   │ │  │
│  │  │  │           localStorage / sessionStorage              │   │ │  │
│  │  │  │  • User session                                       │   │ │  │
│  │  │  │  • Auth tokens                                        │   │ │  │
│  │  │  │  • App preferences                                    │   │ │  │
│  │  │  │  • Offline indicators                                 │   │ │  │
│  │  │  └──────────────────────────────────────────────────────┘   │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │              BACKGROUND SYNC (when online)                    │ │  │
│  │  │                                                               │ │  │
│  │  │   1. Detect online event                                     │ │  │
│  │  │   2. Query IndexedDB for unsynced data                       │ │  │
│  │  │   3. POST data to server APIs                                │ │  │
│  │  │   4. Mark records as synced on success                       │ │  │
│  │  │   5. Update cache with fresh data                            │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ (When Online)
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                            SERVER (XAMPP)                                 │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                          API ENDPOINTS                              │  │
│  │                                                                     │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐ │  │
│  │  │  /api/auth.php   │  │/api/sync-        │  │/api/check-      │ │  │
│  │  │  • Login         │  │ attendance.php   │  │ version.php     │ │  │
│  │  │  • Session       │  │ • Sync records   │  │ • App updates   │ │  │
│  │  └──────────────────┘  └──────────────────┘  └─────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                          DATABASE (MySQL)                           │  │
│  │                                                                     │  │
│  │  ┌─────────┐  ┌─────────────┐  ┌──────────┐  ┌──────────────┐   │  │
│  │  │  Users  │  │ Attendance  │  │ Students │  │   Sections   │   │  │
│  │  └─────────┘  └─────────────┘  └──────────┘  └──────────────┘   │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
                         OFFLINE REQUEST FLOW
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ SCENARIO 1: VIEWING A PAGE OFFLINE                                      │
└─────────────────────────────────────────────────────────────────────────┘

User Request → Service Worker → Cache Check → Cache Hit ✓ → Return Cached Page
                                    ↓
                               Cache Miss ✗
                                    ↓
                             Network Request → Network Fail ✗
                                    ↓
                             Return offline.html


┌─────────────────────────────────────────────────────────────────────────┐
│ SCENARIO 2: SUBMITTING DATA OFFLINE (QR Scan)                           │
└─────────────────────────────────────────────────────────────────────────┘

User Scans QR → Check Online Status → Offline ✗
                        ↓
                Store in IndexedDB
                        ↓
                Show "Saved Offline" Message
                        ↓
                [Wait for Connection]
                        ↓
                Detect Online Event
                        ↓
                Background Sync Triggered
                        ↓
                POST to /api/sync-attendance.php
                        ↓
                Success ✓ → Mark as Synced → Update UI


┌─────────────────────────────────────────────────────────────────────────┐
│ SCENARIO 3: API REQUEST WHILE OFFLINE                                   │
└─────────────────────────────────────────────────────────────────────────┘

User Action → API Request → Service Worker Intercept
                                    ↓
                            Check Online Status
                                    ↓
                                 Offline ✗
                                    ↓
                            Check API Cache
                                    ↓
                         ┌──────────┴──────────┐
                     Cache Hit ✓          Cache Miss ✗
                         ↓                      ↓
                  Return Cached          Return offline-data.json
                    Response                  (Fallback)


═══════════════════════════════════════════════════════════════════════════
                       CACHING STRATEGY DECISION TREE
═══════════════════════════════════════════════════════════════════════════

                            Request Received
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
              Static Asset?    API Call?    HTML Page?
                    │              │              │
                    ▼              ▼              ▼
              ┌─────────┐    ┌─────────┐    ┌─────────┐
              │ CACHE   │    │ NETWORK │    │ NETWORK │
              │ FIRST   │    │ FIRST   │    │ FIRST   │
              └─────────┘    └─────────┘    └─────────┘
                    │              │              │
              Return cache    Try network    Try network
              if available    fallback to    fallback to
              else fetch      cache if       cache if
              from network    offline        offline


═══════════════════════════════════════════════════════════════════════════
                        SYNC PROCESS FLOW
═══════════════════════════════════════════════════════════════════════════

┌───────────────────────────────────────────────────────────────────────┐
│                                                                        │
│  1. OFFLINE DATA COLLECTION                                           │
│     ┌──────────┐  ┌──────────┐  ┌──────────┐                        │
│     │ QR Scan  │  │  Forms   │  │  Login   │                        │
│     └────┬─────┘  └────┬─────┘  └────┬─────┘                        │
│          └─────────────┴─────────────┘                               │
│                      │                                                │
│                      ▼                                                │
│              ┌───────────────┐                                        │
│              │   IndexedDB   │                                        │
│              │  (synced: NO) │                                        │
│              └───────────────┘                                        │
│                                                                        │
│  2. CONNECTION RESTORED                                               │
│     ┌──────────────┐                                                  │
│     │ Online Event │                                                  │
│     └──────┬───────┘                                                  │
│            ▼                                                           │
│     ┌──────────────────┐                                              │
│     │ Background Sync  │                                              │
│     │    Triggered     │                                              │
│     └──────┬───────────┘                                              │
│            │                                                           │
│  3. SYNC PROCESS                                                      │
│            ▼                                                           │
│     ┌─────────────────────────┐                                       │
│     │ Query Unsynced Records  │                                       │
│     └──────┬──────────────────┘                                       │
│            │                                                           │
│            ▼                                                           │
│     For each record:                                                  │
│     ┌────────────────┐                                                │
│     │ POST to Server │                                                │
│     └────────┬───────┘                                                │
│              │                                                         │
│      ┌───────┴────────┐                                               │
│      ▼                ▼                                                │
│  Success ✓        Fail ✗                                              │
│      │                │                                                │
│      ▼                ▼                                                │
│  Mark Synced    Keep for Retry                                        │
│                                                                        │
│  4. COMPLETION                                                        │
│     ┌─────────────────┐                                               │
│     │  Update Cache   │                                               │
│     │  Notify User    │                                               │
│     └─────────────────┘                                               │
│                                                                        │
└───────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
                        CACHE LIFECYCLE
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  SERVICE WORKER LIFECYCLE:                                              │
│                                                                          │
│  ┌─────────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐        │
│  │Installing│ ──→ │ Waiting  │ ──→ │ Activating│ ──→ │ Active  │       │
│  └─────────┘     └──────────┘     └──────────┘     └─────────┘        │
│       │                                   │              │              │
│       ▼                                   ▼              ▼              │
│   Create caches               Delete old caches    Handle requests     │
│   Pre-cache URLs              Claim clients        Intercept fetches   │
│                                                     Background sync     │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ INSTALL (sw.js install event)                                  │    │
│  │ • Open cache: kes-smart-static-v1                              │    │
│  │ • Add URLs: index.php, dashboard.php, assets/*                 │    │
│  │ • Create fallback cache: offline.html                          │    │
│  │ • skipWaiting() - force activation                             │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ ACTIVATE (sw.js activate event)                                │    │
│  │ • Delete old caches (different version)                        │    │
│  │ • clients.claim() - take control immediately                   │    │
│  │ • Ready to intercept requests                                  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ FETCH (sw.js fetch event)                                      │    │
│  │ • Intercept all network requests                               │    │
│  │ • Apply caching strategy based on request type                 │    │
│  │ • Return cached or network response                            │    │
│  │ • Fallback to offline page if needed                           │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
                        STORAGE HIERARCHY
═══════════════════════════════════════════════════════════════════════════

                    ┌────────────────────────────┐
                    │     Browser Storage        │
                    └────────────┬───────────────┘
                                 │
           ┌─────────────────────┼──────────────────────┐
           │                     │                      │
    ┌──────▼──────┐     ┌────────▼────────┐    ┌──────▼──────┐
    │Cache Storage│     │   IndexedDB     │    │ localStorage│
    │  (50-100MB) │     │  (50MB-Unlim)   │    │   (5-10MB)  │
    └──────┬──────┘     └────────┬────────┘    └──────┬──────┘
           │                     │                     │
    ┌──────▼──────┐      ┌───────▼────────┐    ┌─────▼──────┐
    │   Static    │      │     Login      │    │   Session  │
    │   Dynamic   │      │  Attendance    │    │  Auth Token│
    │     API     │      │     Forms      │    │ Preferences│
    └─────────────┘      └────────────────┘    └────────────┘


═══════════════════════════════════════════════════════════════════════════

Legend:
  → : Data flow / Process flow
  ✓ : Success / Available
  ✗ : Failure / Unavailable
  │ : Relationship / Connection
  ┌─┐ : Component / Process box
```
